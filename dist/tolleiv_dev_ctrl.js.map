{"version":3,"sources":["../src/tolleiv_dev_ctrl.js"],"names":["MetricsPanelCtrl","_","moment","angular","TimeSeries","TolleivDevCtrl","$scope","$injector","default_cfg","tableColumn","prefix","prefixFontSize","postfix","postfixFontSize","valueMaps","value","op","text","colorValue","defaults","panel","tableColumnOptions","events","on","onInitEditMode","bind","onDataReceived","fontSizes","addEditorTab","dataList","data","dataType","tableData","map","tableHandler","setTableValues","console","log","render","datapoints_1","columnNames_1","columns","forEach","column","columnIndex","find","setTableColumnToSensibleDefault","rows","row","datapoint","key","push","length","col","type","undefined","isString","valueFormatted","escape","valueRounded","decimalInfo","getDecimalsForValue","formatFunc","kbn","valueFormats","format","decimals","scaledDecimals","roundValue","setValueMapping","i","parseFloat","scope","elem","attrs","ctrl","templateSrv","applyColoringThresholds","valueString","color","getColorForValue","getSpan","className","fontSize","replace","scopedVars","getBigValueHtml","body","valueFontSize","html","renderingCompleted","templateUrl"],"mappings":"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","file":"tolleiv_dev_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\n\nimport _ from 'lodash';\nimport moment from 'moment';\nimport angular from 'angular';\n\nimport TimeSeries from 'app/core/time_series2';\n\nexport class TolleivDevCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector) {\n\n    var default_cfg = {\n      tableColumn: '',\n      prefix: '',\n      prefixFontSize: '50%',\n      postfix: '',\n      postfixFontSize: '50%',\n      valueMaps: [\n        { value: 'null', op: '=', text: 'N/A' }\n      ],\n      colorValue: false\n    }\n\n    super($scope, $injector);\n    _.defaults(this.panel, default_cfg);\n\n    this.tableColumnOptions = {}\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n  }\n\n  onInitEditMode() {\n     this.fontSizes = ['20%', '30%','50%','70%','80%','100%', '110%', '120%', '150%', '170%', '200%'];\n     this.addEditorTab('Options', 'public/plugins/tolleiv-dev-panel/editor.html', 2);\n  }\n\n  onDataReceived(dataList) {\n\t  var data = {};\n    \n    this.dataType = 'table';\n    var tableData = dataList.map(this.tableHandler.bind(this));\n    this.setTableValues(tableData, data);\n    //console.log(tableData)\n    console.log(data)\n    this.data = data;\n    this.render();\n  }\n\n  tableHandler(tableData) {\n    var datapoints_1 = [];\n    var columnNames_1 = {};\n    tableData.columns.forEach(function (column, columnIndex) {\n        columnNames_1[columnIndex] = column.text;\n    });\n    this.tableColumnOptions = columnNames_1;\n    if (!_.find(tableData.columns, ['text', this.panel.tableColumn])) {\n        this.setTableColumnToSensibleDefault(tableData);\n    }\n    tableData.rows.forEach(function (row) {\n        var datapoint = {};\n        row.forEach(function (value, columnIndex) {\n            var key = columnNames_1[columnIndex];\n            datapoint[key] = value;\n        });\n        datapoints_1.push(datapoint);\n    });\n    return datapoints_1;\n  }\n\n  setTableColumnToSensibleDefault(tableData) {\n      if (this.tableColumnOptions.length === 1) {\n          this.panel.tableColumn = this.tableColumnOptions[0];\n      }\n      else {\n          this.panel.tableColumn = _.find(tableData.columns, function (col) { return col.type !== 'time'; }).text;\n      }\n  }\n\n  setTableValues(tableData, data) {\n      if (!tableData || tableData.length === 0) {\n          return;\n      }\n      if (tableData[0].length === 0 || tableData[0][0][this.panel.tableColumn] === undefined) {\n          return;\n      }\n      var datapoint = tableData[0][0];\n      data.value = datapoint[this.panel.tableColumn];\n      if (_.isString(data.value)) {\n          data.valueFormatted = _.escape(data.value);\n          data.value = 0;\n          data.valueRounded = 0;\n      }\n      else {\n          var decimalInfo = this.getDecimalsForValue(data.value);\n          var formatFunc = kbn.valueFormats[this.panel.format];\n          data.valueFormatted = formatFunc(datapoint[this.panel.tableColumn], decimalInfo.decimals, decimalInfo.scaledDecimals);\n          data.valueRounded = kbn.roundValue(data.value, this.panel.decimals || 0);\n      }\n      this.setValueMapping(data);\n  }\n  setValueMapping(data) {\n    for (var i = 0; i < this.panel.valueMaps.length; i++) {\n        var map = this.panel.valueMaps[i];\n        // special null case\n        if (map.value === 'null') {\n            if (data.value === null || data.value === void 0) {\n                data.valueFormatted = map.text;\n                return;\n            }\n            continue;\n        }\n        // value/number to text mapping\n        var value = parseFloat(map.value);\n        if (value === data.valueRounded) {\n            data.valueFormatted = map.text;\n            return;\n        }\n    }\n    \n    if (data.value === null || data.value === void 0) {\n        data.valueFormatted = \"no value\";\n    }\n  }\n  link(scope, elem, attrs, ctrl) {\n    var data = {}\n    var panel = ctrl.panel;\n    var templateSrv = this.templateSrv;\n    elem = elem.find('.tolleiv-dev-panel');\n\n    function applyColoringThresholds(value, valueString) {\n      if (!panel.colorValue) {\n        return valueString;\n      }\n\n      var color = getColorForValue(data, value);\n      if (color) {\n        return '<span style=\"color:' + color + '\">'+ valueString + '</span>';\n      }\n\n      return valueString;\n    }\n\n    function getSpan(className, fontSize, value)  {\n      value = templateSrv.replace(value, data.scopedVars);\n      return '<span class=\"' + className + '\" style=\"font-size:' + fontSize + '\">' +\n        value + '</span>';\n    }\n\n    function getBigValueHtml() {\n      var body = '<div class=\"singlestat-panel-value-container\">';\n\n      if (panel.prefix) { body += getSpan('singlestat-panel-prefix', panel.prefixFontSize, panel.prefix); }\n\n      var value = applyColoringThresholds(data.value, data.valueFormatted);\n      body += getSpan('singlestat-panel-value', panel.valueFontSize, value);\n\n      if (panel.postfix) { body += getSpan('singlestat-panel-postfix', panel.postfixFontSize, panel.postfix); }\n\n      body += '</div>';\n\n      return body;\n    }\n\n    function render() {\n      console.log('render')\n      if (!ctrl.data) { return; }\n      data = ctrl.data;\n      elem.html(getBigValueHtml());\n      console.log('render - done?')\n    }\n\n    this.events.on('render', function() {\n      render();\n      ctrl.renderingCompleted();\n    });\n  }\n\n}\n\nTolleivDevCtrl.templateUrl = 'module.html';\n"]}